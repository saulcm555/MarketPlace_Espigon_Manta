# ============================================
# Docker Compose - MarketPlace Espigón Manta
# Orquestación de todos los microservicios
# ============================================

networks:
  marketplace-network:
    driver: bridge

volumes:
  redis-data:
  postgres-data:
  n8n-data:

services:
  # ==========================================
  # Infraestructura - Redis
  # ==========================================
  redis:
    image: redis:7-alpine
    container_name: marketplace-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - marketplace-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # Auth Service (Puerto 4001)
  # ==========================================
  auth-service:
    build:
      context: ./auth_service
      dockerfile: Dockerfile
    container_name: auth-service
    restart: unless-stopped
    ports:
      - "4001:4001"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=4001
      # JWT Configuration
      - JWT_SECRET=${JWT_SECRET:?JWT_SECRET is required}
      - JWT_ACCESS_EXPIRES_IN=${JWT_ACCESS_EXPIRES_IN:-15m}
      - JWT_REFRESH_EXPIRES_IN=${JWT_REFRESH_EXPIRES_IN:-7d}
      - JWT_ISSUER=auth-service
      - JWT_AUDIENCE=marketplace-espigon
      # Database (Supabase) - Usa pooler port
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT_POOLER:-6543}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_DATABASE=${DB_DATABASE:-postgres}
      - DB_SCHEMA=${DB_SCHEMA_AUTH:-auth_service}
      # Rate Limiting
      - RATE_LIMIT_LOGIN_POINTS=10
      - RATE_LIMIT_LOGIN_DURATION=60
      - RATE_LIMIT_LOGIN_BLOCK_DURATION=300
      - RATE_LIMIT_REGISTER_POINTS=5
      - RATE_LIMIT_REGISTER_DURATION=60
      - RATE_LIMIT_REGISTER_BLOCK_DURATION=600
      # Bcrypt
      - BCRYPT_SALT_ROUNDS=10
      # REST Service URL
      - REST_SERVICE_URL=http://rest-service:3000
    networks:
      - marketplace-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:4001/health',r=>process.exit(r.statusCode===200?0:1)).on('error',()=>process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ==========================================
  # REST Service (Puerto 3000)
  # ==========================================
  rest-service:
    build:
      context: ./rest_service
      dockerfile: Dockerfile
    container_name: rest-service
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=3000
      # Database (Supabase) - usa pooler port para mejor concurrencia
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT_POOLER:-6543}
      - DB_USER=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_DATABASE:-postgres}
      # Redis
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_URL=redis://redis:6379
      # Supabase Storage
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      # JWT
      - JWT_SECRET=${JWT_SECRET:?JWT_SECRET is required}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-24h}
      # WebSocket Service
      - REALTIME_SERVICE_URL=http://realtime-service:8085
      # Admin Seed
      - ADMIN_NAME=${ADMIN_NAME:-Admin}
      - ADMIN_EMAIL=${ADMIN_EMAIL:-admin@espigon.com}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:?ADMIN_PASSWORD is required}
      - ADMIN_PHONE=${ADMIN_PHONE:-0000000000}
    depends_on:
      - redis
    networks:
      - marketplace-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health',r=>process.exit(r.statusCode===200?0:1)).on('error',()=>process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # ==========================================
  # Payment Service (Puerto 3001)
  # ==========================================
  payment-service:
    build:
      context: ./payment_service
      dockerfile: Dockerfile
    container_name: payment-service
    restart: unless-stopped
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=3001
      # Database (Supabase) - usa puerto directo
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT_DIRECT:-5432}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_DATABASE=${DB_DATABASE:-postgres}
      - DB_SCHEMA=${DB_SCHEMA_PAYMENT:-public}
      # Payment Provider
      - PAYMENT_PROVIDER=${PAYMENT_PROVIDER:-mock}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
      # Webhooks
      - WEBHOOK_TIMEOUT=${WEBHOOK_TIMEOUT:-10000}
      - WEBHOOK_RETRY_ATTEMPTS=${WEBHOOK_RETRY_ATTEMPTS:-3}
      # Internal API Key
      - INTERNAL_API_KEY=${INTERNAL_API_KEY}
    networks:
      - marketplace-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/health',r=>process.exit(r.statusCode===200?0:1)).on('error',()=>process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ==========================================
  # Report Service - GraphQL (Puerto 4000)
  # ==========================================
  report-service:
    build:
      context: ./report_service
      dockerfile: Dockerfile
    container_name: report-service
    restart: unless-stopped
    ports:
      - "4000:4000"
    environment:
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
      - DATABASE_URL=postgresql://${DB_USERNAME}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT_POOLER:-6543}/${DB_DATABASE}
    networks:
      - marketplace-network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:4000/').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ==========================================
  # Realtime Service - WebSocket (Puerto 8085)
  # ==========================================
  realtime-service:
    build:
      context: ./realtime_service
      dockerfile: Dockerfile
    container_name: realtime-service
    restart: unless-stopped
    ports:
      - "8085:8085"
    environment:
      - PORT=8085
      - ENVIRONMENT=${NODE_ENV:-development}
      - JWT_SECRET=${JWT_SECRET:?JWT_SECRET is required}
      - REDIS_ADDR=redis:6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
    depends_on:
      - redis
    networks:
      - marketplace-network
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:8085/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ==========================================
  # MCP Service - Ejecutor de Tools (Puerto 3003)
  # ==========================================
  mcp-service:
    build:
      context: ./mcp_service
      dockerfile: Dockerfile
    container_name: mcp-service
    restart: unless-stopped
    ports:
      - "3003:3003"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=3003
      - REST_SERVICE_URL=http://rest-service:3000
      - PAYMENT_SERVICE_URL=http://payment-service:3001
      - REPORT_SERVICE_URL=http://report-service:4000
      # Internal API Key para autenticación entre servicios
      - INTERNAL_API_KEY=${INTERNAL_API_KEY}
      # Demo Client Token para crear_orden
      - DEMO_CLIENT_TOKEN=${DEMO_CLIENT_TOKEN}
    depends_on:
      - rest-service
      - payment-service
      - report-service
    networks:
      - marketplace-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3003/health',r=>process.exit(r.statusCode===200?0:1)).on('error',()=>process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ==========================================
  # AI Orchestrator - Cerebro IA (Puerto 3004)
  # ==========================================
  ai-orchestrator:
    build:
      context: ./ai_orchestrator
      dockerfile: Dockerfile
    container_name: ai-orchestrator
    restart: unless-stopped
    ports:
      - "3004:3004"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=3004
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:5173}
      # MCP Service
      - MCP_SERVICE_URL=http://mcp-service:3003
      # Gemini API
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-2.0-flash}
      # Microservicios (para health checks)
      - REST_SERVICE_URL=http://rest-service:3000
      - PAYMENT_SERVICE_URL=http://payment-service:3001
      - REPORT_SERVICE_URL=http://report-service:4000
    depends_on:
      - mcp-service
    networks:
      - marketplace-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3004/health',r=>process.exit(r.statusCode===200?0:1)).on('error',()=>process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ==========================================
  # n8n - Event Bus (Puerto 5678) - PILAR 4
  # ==========================================
  n8n:
    image: docker.n8n.io/n8nio/n8n:latest
    container_name: marketplace-n8n
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      # Autenticación básica
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASSWORD:-admin123}
      # Configuración de n8n
      - N8N_HOST=localhost
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=http://localhost:5678/
      - GENERIC_TIMEZONE=America/Guayaquil
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY:-changeme-encryption-key-32chars}
      # URLs de microservicios internos (para HTTP Request nodes)
      - REST_SERVICE_URL=http://rest-service:3000
      - PAYMENT_SERVICE_URL=http://payment-service:3001
      - REALTIME_SERVICE_URL=http://realtime-service:8085
      - AI_ORCHESTRATOR_URL=http://ai-orchestrator:3004
      - REPORT_SERVICE_URL=http://report-service:4000
      - AUTH_SERVICE_URL=http://auth-service:4001
      # Credenciales para comunicación interna
      - INTERNAL_API_KEY=${INTERNAL_API_KEY}
      - JWT_SECRET=${JWT_SECRET}
      # Stripe (para validar webhooks)
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
      # Telegram Bot (opcional)
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      # SMTP para envío de emails
      - SMTP_HOST=${SMTP_HOST:-smtp.gmail.com}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER:-}
      - SMTP_PASSWORD=${SMTP_PASSWORD:-}
      - SMTP_FROM=${SMTP_FROM:-noreply@espigon.com}
    volumes:
      - n8n-data:/home/node/.n8n
    networks:
      - marketplace-network
    depends_on:
      - rest-service
      - payment-service
      - realtime-service
      - ai-orchestrator
      - report-service
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

# ==========================================
# Notas de Uso
# ==========================================
# 
# Iniciar todos los servicios:
#   docker-compose up -d
#
# Ver logs de todos los servicios:
#   docker-compose logs -f
#
# Ver logs de un servicio específico:
#   docker-compose logs -f auth-service
#
# Detener todos los servicios:
#   docker-compose down
#
# Reconstruir imágenes y reiniciar:
#   docker-compose up -d --build
#
# Ver estado de los servicios:
#   docker-compose ps
#
# Puertos:
#   - Auth Service:      http://localhost:4001
#   - REST Service:      http://localhost:3000
#   - Payment Service:   http://localhost:3001
#   - Report Service:    http://localhost:4000
#   - Realtime Service:  ws://localhost:8085
#   - MCP Service:       http://localhost:3003
#   - AI Orchestrator:   http://localhost:3004
#   - n8n Event Bus:     http://localhost:5678
#   - Redis:             localhost:6379
# ==========================================
